<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>SyncFromNotion</title>
  <style>
    /* Reset & Base */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background-color: #2c2c2c;
      color: #fff;
      font-size: 11px;
      padding: 16px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Helper Classes */
    .hidden { display: none !important; }
    .flex { display: flex; }
    .flex-col { flex-direction: column; }
    .gap-8 { gap: 8px; }
    .gap-4 { gap: 4px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .w-full { width: 100%; }
    .mb-8 { margin-bottom: 8px; }
    .mb-16 { margin-bottom: 16px; }

    /* Component Styles */
    h2 { font-size: 13px; font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
    h2::before { content: 'ğŸ”„'; font-size: 12px; }
    
    label { color: #b3b3b3; margin-bottom: 4px; display: block; }
    
    input, select {
      background: #3c3c3c;
      border: 1px solid #3c3c3c;
      color: #fff;
      padding: 8px;
      border-radius: 4px;
      font-size: 11px;
      width: 100%;
      outline: none;
    }
    input:focus, select:focus { border-color: #18a0fb; }
    input::placeholder { color: #888; }
    
    /* Buttons */
    button {
      background: #18a0fb;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      font-size: 11px;
      transition: background 0.2s;
    }
    button:hover { background: #0d8ce0; }
    button:disabled { background: #555; cursor: not-allowed; color: #aaa; }
    button.secondary { background: transparent; border: 1px solid #555; color: #ccc; }
    button.secondary:hover { border-color: #888; color: #fff; }

    /* Steps */
    .step-container { flex: 1; overflow-y: auto; padding-right: 2px; }
    .step-header { font-weight: 600; color: #fff; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #444; }
    
    /* Mapping List */
    .mapping-item {
      background: #333;
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      border: 1px solid #444;
    }
    .layer-info { display: flex; align-items: center; gap: 6px; margin-bottom: 6px; }
    .layer-icon { font-size: 10px; color: #888; }
    .layer-name { font-weight: 500; color: #ddd; }
    .layer-type { font-size: 9px; background: #444; padding: 2px 4px; border-radius: 2px; color: #aaa; }

    /* Status Bar */
    .status-bar {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid #444;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 10px;
      color: #999;
    }
    .spinner {
      width: 10px; height: 10px;
      border: 2px solid #555; border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* è¿›åº¦æ—¥å¿—åŒºåŸŸ */
    #progress-log {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 4px;
      padding: 8px;
      margin-top: 12px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
      font-size: 10px;
      line-height: 1.4;
    }
    #progress-log.hidden {
      display: none;
    }
    .log-entry {
      color: #999;
      padding: 2px 0;
    }
    .log-entry.success {
      color: #4dff88;
    }
    .log-entry.info {
      color: #4da6ff;
    }
    .log-entry.warning {
      color: #ffb84d;
    }
    .log-entry.error {
      color: #ff4d4d;
    }

  </style>
</head>
<body>

  <h2>SyncFromNotion <span id="version-display" style="font-size:10px; color:#888; font-weight:normal; margin-left:8px;">v1.2.0</span></h2>

  <div id="step-1" class="step-container">
    <div class="step-header">Step 1: ç²å–æ•¸æ“š</div>
    <div class="mb-16">
      <label>Webhook URL</label>
      <input type="text" id="webhook-url" placeholder="https://hook.us2.make.com/..." />
    </div>
    <button id="btn-fetch" class="w-full">ğŸ“¥ æ‹‰å–æ•¸æ“š</button>
  </div>

  <div id="step-preview" class="step-container hidden">
    <div class="step-header">Step 1.5: æ•¸æ“šé è¦½</div>
    <p class="mb-8" style="color:#aaa">ç¢ºèªæ¬„ä½èˆ‡å…§å®¹æ˜¯å¦æ­£ç¢º</p>
    
    <!-- Navigation Bar -->
    <div class="flex gap-8 mb-8" style="justify-content: space-between; align-items: center; background: #333; padding: 4px 8px; border-radius: 4px;">
      <button id="btn-prev-record" class="secondary" style="width: 30px; padding: 4px;">â—€</button>
      <span id="preview-counter" style="font-size: 11px; color: #fff;">1 / --</span>
      <button id="btn-next-record" class="secondary" style="width: 30px; padding: 4px;">â–¶</button>
    </div>
    <div id="preview-list" class="mb-16" style="max-height: 250px; overflow-y: auto; background: #222; padding: 8px; border: 1px solid #444; border-radius: 4px;">
      <!-- Preview items -->
    </div>
    <div class="flex gap-8">
      <button id="btn-preview-back" class="secondary">é‡æ–°è¼¸å…¥ URL</button>
      <button id="btn-preview-refresh" class="secondary">ğŸ”„ åˆ·æ–°</button>
      <button id="btn-preview-next" class="w-full">ä¸‹ä¸€æ­¥ï¼šé¸æ“‡çµ„ä»¶</button>
    </div>
  </div>

  <div id="step-2" class="step-container hidden">
    <div class="step-header">Step 2: é¸æ“‡çµ„ä»¶ (Component)</div>
    
    <div class="mb-16 p-2 bg-gray-800 rounded border border-gray-700 hidden" id="selected-comp-info" style="background:#222; padding:8px; border:1px solid #444;">
      <div style="font-weight:bold; margin-bottom:8px;" id="comp-name">--</div>
      <button id="btn-use-saved-comp" class="w-full secondary" style="font-size:11px; padding:6px;">
        âœ… ä½¿ç”¨é€™å€‹ Component
      </button>
    </div>
    
    <button id="btn-read-selection" class="w-full secondary">ğŸ” è®€å–é¸ä¸­çš„ Component</button>
  </div>

  <div id="step-3" class="step-container hidden">
    <div class="step-header">Step 3: æ˜ å°„æ¬„ä½</div>
    
    <div class="mb-16">
      <label>å”¯ä¸€ ID æ¬„ä½ (è­˜åˆ¥ç”¨)</label>
      <select id="id-field-select"></select>
    </div>

    <label class="mb-8">åœ–å±¤å°æ‡‰é—œä¿‚</label>
    <div id="mapping-list">
      <!-- Mappings will be injected here -->
    </div>
    
    <div class="flex gap-8 mt-4">
      <button id="btn-back-2" class="secondary">â¬…ï¸ é‡æ–°é¸æ“‡ Component</button>
      <button id="btn-confirm-mapping" class="w-full secondary">âœ… ç¢ºèªæ˜ å°„</button>
    </div>
    
    <button id="btn-sync" class="w-full" style="margin-top:8px;">ğŸš€ é–‹å§‹åŒæ­¥ (Sync)</button>
    
    <button id="btn-show-tools" class="w-full secondary" style="margin-top:8px;">
      ğŸ› ï¸ å·¥å…·ï¼šä¿®æ”¹ Instance ID
    </button>
    
    <!-- è¿›åº¦æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="progress-log" class="hidden"></div>
  </div>

  <div id="tools-section" class="step-container hidden">
    <div class="step-header">ğŸ› ï¸ å·¥å…·</div>
    
    <!-- å¿«é€Ÿé…ç½®åŠ è½½ -->
    <div style="margin-bottom:24px; padding-bottom:24px; border-bottom:1px solid #333;">
      <h3 style="font-size:12px; margin-bottom:8px;">âš¡ å¿«é€Ÿé…ç½®</h3>
      <p style="color:#aaa; margin-bottom:12px; font-size:10px;">é€‰ä¸­ä¸€ä¸ª Instanceï¼Œè‡ªåŠ¨åŠ è½½å…¶ Component å’Œæ˜ å°„é…ç½®</p>
      
      <!-- é…ç½®çŠ¶æ€æ˜¾ç¤º -->
      <div id="quick-config-status" class="hidden" style="background:#1a1a1a; border:1px solid #333; border-radius:4px; padding:8px; margin-bottom:12px;">
        <div style="font-size:10px; color:#888; margin-bottom:4px;">å½“å‰é…ç½®:</div>
        <div id="quick-config-component" style="font-size:11px; color:#4dff88; margin-bottom:2px;">Component: --</div>
        <div id="quick-config-mappings" style="font-size:11px; color:#4da6ff;">æ˜ å°„: --</div>
        <div id="quick-config-data" style="font-size:11px; color:#ffb84d; margin-top:2px;">æ•°æ®: --</div>
      </div>
      
      <button id="btn-quick-load" class="w-full secondary">
        âš¡ ä»é€‰ä¸­ Instance åŠ è½½é…ç½®
      </button>
    </div>
    
    <!-- åŒæ­¥é€‰ä¸­çš„ Instance -->
    <div style="margin-bottom:24px; padding-bottom:24px; border-bottom:1px solid #333;">
      <h3 style="font-size:12px; margin-bottom:8px;">ğŸ”„ åŒæ­¥é€‰ä¸­çš„ Instance</h3>
      <p style="color:#aaa; margin-bottom:12px; font-size:10px;">åªæ›´æ–°é€‰ä¸­çš„ instanceï¼Œä¸å½±å“å…¶ä»–æ•°æ®</p>
      
      <button id="btn-sync-selected" class="w-full" disabled>
        ğŸ”„ åŒæ­¥é€‰ä¸­çš„ Instance
      </button>
    </div>
    
    <!-- ä¿®æ”¹ Instance ID -->
    <div>
      <h3 style="font-size:12px; margin-bottom:8px;">âœï¸ ä¿®æ”¹ Instance ID</h3>
      <p style="color:#aaa; margin-bottom:12px; font-size:10px;">é€‰ä¸­ä¸€ä¸ª Instanceï¼Œä¿®æ”¹å…¶ Notion ID</p>
    
    <button id="btn-read-instance-id" class="w-full secondary mb-8">
      ğŸ“ è¯»å–é€‰ä¸­ Instance çš„ ID
    </button>
    
    <div id="current-id-display" class="hidden" style="margin-bottom:12px; padding:8px; background:#222; border:1px solid #444; border-radius:4px;">
      <div style="font-size:10px; color:#888; margin-bottom:4px;">å½“å‰ ID:</div>
      <div id="current-id-value" style="font-family:monospace; color:#4dff88; font-size:11px;"></div>
      <div id="current-node-name" style="font-size:10px; color:#888; margin-top:4px;"></div>
    </div>
    
    <div class="mb-16">
      <label>æ–°çš„ Notion ID</label>
      <input type="text" id="new-id-input" placeholder="è¾“å…¥æ–°çš„ ID" />
    </div>
    
    <button id="btn-update-instance-id" class="w-full" disabled>
      ğŸ’¾ æ›´æ–° ID
    </button>
    
    <button id="btn-back-to-sync" class="w-full secondary" style="margin-top:8px;">
      â¬…ï¸ è¿”å›åŒæ­¥
    </button>
  </div>

  <div class="status-bar">
    <div id="spinner" class="spinner hidden"></div>
    <span id="status-text">å°±ç·’</span>
  </div>

  <script>
    // --- State ---
    let notionData = [];
    let schemaKeys = [];
    let componentLayers = [];
    let currentComponentId = null;
    let currentMappings = []; // [New] Store mappings for image sync phase
    let currentPreviewIndex = 0;

    // --- Elements ---
    const steps = {
      1: document.getElementById('step-1'),
      'preview': document.getElementById('step-preview'),
      2: document.getElementById('step-2'),
      3: document.getElementById('step-3'),
      'tools': document.getElementById('tools-section')
    };
    const webhookInput = document.getElementById('webhook-url');
    const btnFetch = document.getElementById('btn-fetch');
    const btnPreviewNext = document.getElementById('btn-preview-next');
    const btnPreviewBack = document.getElementById('btn-preview-back');
    const previewList = document.getElementById('preview-list');
    const btnReadSelection = document.getElementById('btn-read-selection');
    const btnUseSavedComp = document.getElementById('btn-use-saved-comp');
    const btnSync = document.getElementById('btn-sync');
    const btnConfirmMapping = document.getElementById('btn-confirm-mapping');
    const btnBack2 = document.getElementById('btn-back-2');
    const mappingList = document.getElementById('mapping-list');
    const idFieldSelect = document.getElementById('id-field-select');
    const statusText = document.getElementById('status-text');
    const spinner = document.getElementById('spinner');
    
    // Tools section elements
    const btnSyncSelected = document.getElementById('btn-sync-selected');
    const btnReadInstanceId = document.getElementById('btn-read-instance-id');
    const btnUpdateInstanceId = document.getElementById('btn-update-instance-id');
    const currentIdDisplay = document.getElementById('current-id-display');
    const currentIdValue = document.getElementById('current-id-value');
    const currentNodeName = document.getElementById('current-node-name');
    const newIdInput = document.getElementById('new-id-input');

    // Quick Config elements
    const btnQuickLoad = document.getElementById('btn-quick-load');
    const quickConfigStatus = document.getElementById('quick-config-status');
    const quickConfigComponent = document.getElementById('quick-config-component');
    const quickConfigMappings = document.getElementById('quick-config-mappings');
    const quickConfigData = document.getElementById('quick-config-data');
    
    // --- Helpers (Defined early) ---
    function setStatus(type, msg) {
      statusText.textContent = msg;
      statusText.className = type;
      spinner.classList.toggle('hidden', type !== 'loading');
      if (type === 'error') statusText.style.color = '#ff4d4d';
      else if (type === 'success') statusText.style.color = '#4dff88';
      else statusText.style.color = '#999';
    }

    // è¿›åº¦æ—¥å¿—å‡½æ•°
    const progressLog = document.getElementById('progress-log');
    const MAX_LOG_ENTRIES = 50; // æœ€å¤šä¿ç•™50æ¡æ—¥å¿—
    
    function addLog(message, type = 'info') {
      // æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
      progressLog.classList.remove('hidden');
      
      // åˆ›å»ºæ—¥å¿—æ¡ç›®
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      
      // æ·»åŠ æ—¶é—´æˆ³
      const now = new Date();
      const timestamp = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
      entry.textContent = `[${timestamp}] ${message}`;
      
      // æ·»åŠ åˆ°æ—¥å¿—åŒºåŸŸ
      progressLog.appendChild(entry);
      
      // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡
      while (progressLog.children.length > MAX_LOG_ENTRIES) {
        progressLog.removeChild(progressLog.firstChild);
      }
      
      // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
      progressLog.scrollTop = progressLog.scrollHeight;
    }
    
    function clearLog() {
      progressLog.innerHTML = '';
      progressLog.classList.add('hidden');
    }


    function showStep(step) {
      Object.keys(steps).forEach(k => steps[k].classList.add('hidden'));
      if (steps[step]) {
        steps[step].classList.remove('hidden');
      }
      
      // å½“è¿›å…¥å·¥å…·åŒºæ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰é…ç½®å¯ç”¨
      if (step === 'tools') {
        // å¦‚æœå·²æœ‰ component å’Œ mappingsï¼Œå¯ç”¨åŒæ­¥é€‰ä¸­æŒ‰é’®
        if (currentComponentId && currentMappings && currentMappings.length > 0 && notionData && notionData.length > 0) {
          if (btnSyncSelected) {
            btnSyncSelected.disabled = false;
          }
          
          // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
          if (quickConfigStatus && !quickConfigStatus.classList.contains('hidden')) {
            // çŠ¶æ€å·²æ˜¾ç¤ºï¼Œä¿æŒ
          } else {
            // å°è¯•ä» storage åŠ è½½å¹¶æ˜¾ç¤ºæç¤º
            loadStorage('last_component_id').then(savedId => {
              if (savedId && selectedCompInfo) {
                const compNameEl = document.getElementById('comp-name');
                if (compNameEl && compNameEl.textContent !== '--') {
                  // åœ¨å·¥å…·åŒºæç¤ºå¯ä»¥ä½¿ç”¨å¿«é€ŸåŠ è½½
                  setStatus('info', 'æç¤ºï¼šå¯ä»¥ä½¿ç”¨"ä»é€‰ä¸­ Instance åŠ è½½é…ç½®"æˆ–å·²æœ‰é…ç½®ç›´æ¥åŒæ­¥');
                }
              }
            });
          }
        } else {
          // æ— é…ç½®ï¼Œæ˜¾ç¤ºæç¤º
          setStatus('info', 'è¯·å…ˆåŠ è½½é…ç½®æˆ–å®Œæˆ Step 1-3');
        }
      }
    }

    // --- Actions ---

    // Step 1: Fetch Data
    
    async function fetchData() {
       const url = webhookInput.value.trim();
       if (!url) {
         setStatus('error', 'è«‹è¼¸å…¥ URL');
         return false;
       }
       
       setStatus('loading', 'æ­£åœ¨æ‹‰å–æ•¸æ“š...');
       btnFetch.disabled = true;

       try {
         const resp = await fetch(url);
         if (!resp.ok) throw new Error('HTTP ' + resp.status);
         let data = await resp.json();
         
         // Smart extract array
         if (!Array.isArray(data)) {
           const extracted = extractArray(data);
           if (extracted) {
             data = extracted;
           } else {
             const preview = JSON.stringify(data).substring(0, 100);
             throw new Error(`æœªæ‰¾åˆ°æ•¸æ“šé™£åˆ—ã€‚æ”¶åˆ°: ${preview}...`);
           }
         }

         if (data.length === 0) throw new Error('é™£åˆ—ç‚ºç©º (0 items)');

         // å·®ç•°å°æ¯” (Smart logic)
         const creatingCount = data.length;
         // TODO: Check existing IDs if possible, but for now just show count
         
         notionData = data;
         // Extract all unique keys from first few records
         const allKeys = new Set();
         data.slice(0, 5).forEach(item => Object.keys(item).forEach(k => allKeys.add(k)));
         schemaKeys = Array.from(allKeys);

         setStatus('success', `æˆåŠŸç²å– ${data.length} ç­†æ•¸æ“š`);
         
         // Save to cache (Async)
         saveStorage('cached_data', JSON.stringify(data));

         // Render Preview
         renderPreview(0);
         showStep('preview');
         return true;

       } catch (e) {
         setStatus('error', 'å¤±æ•—: ' + e.message);
         return false;
       } finally {
         btnFetch.disabled = false;
       }
    }

    btnFetch.onclick = fetchData;

    // Step 1.5 Preview Actions
    const btnPreviewRefresh = document.getElementById('btn-preview-refresh');
    
    btnPreviewNext.onclick = () => showStep(2);
    btnPreviewBack.onclick = () => showStep(1);
    btnPreviewRefresh.onclick = () => btnFetch.click();

    // Step 2: Read Component
    btnReadSelection.onclick = () => {
      console.log('Sending get-component-layers message...');
      parent.postMessage({ pluginMessage: { type: 'get-component-layers' } }, '*');
      setStatus('loading', 'æ­£åœ¨è®€å– Component...');
    };
    
    // Step 2: Use Saved Component
    if (btnUseSavedComp) {
      btnUseSavedComp.onclick = async () => {
        setStatus('loading', 'æ­£åœ¨åŠ è½½ä¿å­˜çš„ Component...');
        
        const savedComponentId = await loadStorage('last_component_id');
        if (!savedComponentId) {
          setStatus('error', 'æœªæ‰¾åˆ°ä¿å­˜çš„ Component');
          return;
        }
        
        parent.postMessage({ 
          pluginMessage: { 
            type: 'restore-component',
            componentId: savedComponentId
          } 
        }, '*');
      };
    }

    // Step 3 Back
    btnBack2.onclick = () => showStep(2);
    
    // Step 3: Confirm Mapping (ä¿å­˜æ˜ å°„é…ç½®)
    if (btnConfirmMapping) {
      btnConfirmMapping.onclick = async () => {
        console.log('ç‚¹å‡»ç¡®è®¤æ˜ å°„æŒ‰é’®');
        
        // æ”¶é›†æ˜ å°„
        const mappings = [];
        const items = document.querySelectorAll('.mapping-item');
        
        items.forEach(item => {
          const layerNameEl = item.querySelector('.layer-name');
          const fieldSelect = item.querySelector('.field-select');
          const typeSelect = item.querySelector('.type-select');
          
          // æ·»åŠ  null æ£€æŸ¥
          if (!layerNameEl || !fieldSelect || !typeSelect) {
            console.warn('æ˜ å°„é¡¹ç¼ºå°‘å¿…è¦å…ƒç´ ', item);
            return;
          }
          
          if (fieldSelect.value) {
            mappings.push({
              layerName: layerNameEl.textContent,
              notionField: fieldSelect.value,
              dataType: typeSelect.value
            });
          }
        });
        
        if (mappings.length === 0) {
          setStatus('warning', 'è‡³å°‘éœ€è¦è¨­ç½®ä¸€å€‹æ˜ å°„');
          return;
        }
        
        // ä¿å­˜ ID å­—æ®µ
        const idField = idFieldSelect.value;
        
        // ä¿å­˜æ˜ å°„é…ç½®ï¼ˆä½¿ç”¨å¯¹è±¡æ ¼å¼ï¼Œä¸å®Œæ•´åŒæ­¥ä¸€è‡´ï¼‰
        const mappingData = {
          mappings: mappings,
          idField: idField
        };
        
        currentMappings = mappings;
        await saveStorage('mapping_' + currentComponentId, mappingData);
        
        console.log('[ç¡®è®¤æ˜ å°„] ä¿å­˜æ˜ å°„é…ç½®:', mappingData);
        
        // å¯ç”¨åŒæ­¥é€‰ä¸­æŒ‰é’®ï¼ˆå¦‚æœåœ¨å·¥å…·åŒºï¼‰
        if (btnSyncSelected && notionData && notionData.length > 0) {
          btnSyncSelected.disabled = false;
        }
        
        setStatus('success', `âœ… æ˜ å°„å·²ç¢ºèªä¸¦ä¿å­˜ (${mappings.length} æ¢è¦å‰‡)`);
        console.log('æ˜ å°„å·²ä¿å­˜:', mappings);
        
        // å¯é€‰ï¼šæ˜¾ç¤ºæˆåŠŸæç¤ºå¹¶æä¾›é€‰é¡¹
        setTimeout(() => {
          setStatus('success', 'æ˜ å°„å·²ä¿å­˜ï¼å¯ä»¥é€²å…¥ã€Œå·¥å…·ã€ä½¿ç”¨å¿«é€ŸåŒæ­¥');
        }, 1500);
      };
    }
    
    // Show Tools
    const btnShowTools = document.getElementById('btn-show-tools');
    if (btnShowTools) {
      btnShowTools.onclick = () => showStep('tools');
    }
    
    // Back to Sync from Tools
    const btnBackToSync = document.getElementById('btn-back-to-sync');
    if (btnBackToSync) {
      btnBackToSync.onclick = () => showStep(3);
    }
    
    // Quick Load Configuration
    if (btnQuickLoad) {
      btnQuickLoad.onclick = async () => {
        try {
          clearLog();
          setStatus('loading', 'æ­£åœ¨åŠ è½½é…ç½®...');
          addLog('âš¡ ä»é€‰ä¸­ Instance åŠ è½½é…ç½®', 'info');
          
          // 1. æ£€æŸ¥ Notion æ•°æ®
          if (!notionData || notionData.length === 0) {
            setStatus('error', 'è¯·å…ˆæ‹‰å– Notion æ•°æ®');
            addLog('âŒ æœªæ‰¾åˆ° Notion æ•°æ®ï¼Œè¯·å…ˆæ‹‰å–', 'error');
            return;
          }
          
          // 2. å‘é€åŠ è½½è¯·æ±‚åˆ°åç«¯ï¼ˆä»é€‰ä¸­çš„ instance è·å– componentï¼‰
          const loadResult = await new Promise((resolve) => {
            const handler = (e) => {
              const msg = e.data.pluginMessage;
              if (msg && (msg.type === 'component-data' || msg.type === 'error')) {
                window.removeEventListener('message', handler);
                resolve(msg);
              }
            };
            window.addEventListener('message', handler);
            parent.postMessage({ 
              pluginMessage: { 
                type: 'load-from-selection'
              } 
            }, '*');
            
            // Timeout
            setTimeout(() => {
              window.removeEventListener('message', handler);
              resolve({ type: 'error', message: 'åŠ è½½è¶…æ—¶' });
            }, 3000);
          });
          
          if (loadResult.type === 'error') {
            setStatus('error', loadResult.message);
            addLog(`âŒ ${loadResult.message}`, 'error');
            return;
          }
          
          addLog(`âœ… æ‰¾åˆ° Component: ${loadResult.componentName}`, 'success');
          
          // 3. åŠ è½½è¯¥ component çš„æ˜ å°„é…ç½®
          const savedData = await loadStorage('mapping_' + loadResult.componentId);
          let mappings = [];
          let idField = Object.keys(notionData[0] || {})[0];
          
          console.log('[å¿«é€ŸåŠ è½½] å°è¯•åŠ è½½æ˜ å°„ï¼Œkey:', 'mapping_' + loadResult.componentId);
          console.log('[å¿«é€ŸåŠ è½½] è¯»å–åˆ°çš„æ˜ å°„æ•°æ®:', savedData);
          
          if (savedData) {
            // å¤„ç†å¯¹è±¡æ ¼å¼ {mappings: [...], idField: '...'}
            if (savedData.mappings && Array.isArray(savedData.mappings)) {
              mappings = savedData.mappings;
              idField = savedData.idField || idField;
              console.log('[å¿«é€ŸåŠ è½½] è§£ææ˜ å°„æˆåŠŸ:', mappings);
              addLog(`åŠ è½½æ˜ å°„é…ç½®: ${mappings.length} æ¡è§„åˆ™`, 'success');
            } else {
              console.warn('[å¿«é€ŸåŠ è½½] æ˜ å°„æ•°æ®æ ¼å¼ä¸æ­£ç¡®', savedData);
              addLog('âš ï¸ æ˜ å°„é…ç½®æ ¼å¼é”™è¯¯', 'error');
            }
          } else {
            console.warn('[å¿«é€ŸåŠ è½½] æœªæ‰¾åˆ°æ˜ å°„é…ç½®');
            addLog('âš ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„æ˜ å°„é…ç½®', 'warning');
          }
          
          if (mappings.length === 0) {
            addLog('æç¤ºï¼šè¯·å…ˆåœ¨ Step 3 è®¾ç½®å¹¶ç¡®è®¤æ˜ å°„', 'info');
          }
          
          // 4. è®¾ç½®å…¨å±€å˜é‡
          currentComponentId = loadResult.componentId;
          currentMappings = mappings;
          componentLayers = loadResult.layers;

          // 4.1 Update Mapping UI in background (so Step 3 is correct if visited)
          try {
            renderMappingUI(componentLayers);
            const compNameEl = document.getElementById('comp-name');
            if (compNameEl) compNameEl.textContent = loadResult.componentName;
            const infoEl = document.getElementById('selected-comp-info');
            if (infoEl) infoEl.classList.remove('hidden');
          } catch (e) {
            console.warn('Background UI update failed:', e);
          }
          
          // 5. æ›´æ–°çŠ¶æ€æ˜¾ç¤º
          quickConfigStatus.classList.remove('hidden');
          quickConfigComponent.textContent = `Component: ${loadResult.componentName}`;
          quickConfigMappings.textContent = `æ˜ å°„: ${mappings.length} æ¡è§„åˆ™${mappings.length === 0 ? ' âš ï¸' : ''}`;
          quickConfigData.textContent = `æ•°æ®: ${notionData.length} æ¡è®°å½•`;
          
          // 6. å¯ç”¨åŒæ­¥é€‰ä¸­æŒ‰é’®ï¼ˆå¦‚æœæœ‰æ˜ å°„ï¼‰
          if (mappings.length > 0) {
            btnSyncSelected.disabled = false;
            setStatus('success', 'é…ç½®åŠ è½½æˆåŠŸï¼');
            addLog('âœ… é…ç½®åŠ è½½å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨"åŒæ­¥é€‰ä¸­"åŠŸèƒ½', 'success');
          } else {
            btnSyncSelected.disabled = true;
            setStatus('warning', 'Component å·²åŠ è½½ï¼Œä½†æœªæ‰¾åˆ°æ˜ å°„é…ç½®');
            addLog('æç¤ºï¼šè¯·å…ˆå®Œæˆ Step 1-3 åˆ›å»ºæ˜ å°„é…ç½®', 'info');
          }
          
        } catch (e) {
          console.error('å¿«é€ŸåŠ è½½å¤±è´¥:', e);
          setStatus('error', 'åŠ è½½é…ç½®å¤±è´¥');
          addLog(`âŒ åŠ è½½å¤±è´¥: ${e.message}`, 'error');
        }
      };
    }

    // === Tools Section: Instance ID Management ===
    
    // Sync Selected Instances
    if (btnSyncSelected) {
      btnSyncSelected.onclick = () => {
        // æ¸…ç©ºæ—¥å¿—
        clearLog();
        
        // éªŒè¯æ˜¯å¦å·²ç»å®Œæˆé…ç½®
        if (!currentComponentId || currentMappings.length === 0) {
          setStatus('error', 'è¯·å…ˆåŠ è½½é…ç½®ï¼ˆç‚¹å‡»"ä½¿ç”¨ä¸Šæ¬¡é…ç½®"ï¼‰æˆ–å®Œæˆå®Œæ•´åŒæ­¥æµç¨‹');
          addLog('âŒ æœªæ‰¾åˆ°é…ç½®ä¿¡æ¯', 'error');
          addLog('æç¤ºï¼šç‚¹å‡»"âš¡ ä½¿ç”¨ä¸Šæ¬¡é…ç½®"æˆ–è¿”å›å®Œæˆ Step 1-3', 'warning');
          return;
        }
        
        if (!notionData || notionData.length === 0) {
          setStatus('error', 'è¯·å…ˆæ‹‰å– Notion æ•°æ®');
          addLog('âŒ æœªæ‰¾åˆ° Notion æ•°æ®', 'error');
          return;
        }
        
        // å‘é€åŒæ­¥é€‰ä¸­çš„è¯·æ±‚
        parent.postMessage({ 
          pluginMessage: { 
            type: 'sync-selected',
            componentId: currentComponentId,
            mappings: currentMappings,
            idField: idFieldSelect.value,
            notionData: notionData
          } 
        }, '*');
        setStatus('loading', 'æ­£åœ¨åŒæ­¥é€‰ä¸­çš„ Instance...');
        btnSyncSelected.disabled = true;
      };
    }
    
    // Read Instance ID
    btnReadInstanceId.onclick = () => {
      parent.postMessage({ pluginMessage: { type: 'read-instance-id' } }, '*');
      setStatus('loading', 'æ­£åœ¨è¯»å– Instance ID...');
    };
    
    // Update Instance ID
    btnUpdateInstanceId.onclick = () => {
      const newId = newIdInput.value.trim();
      if (!newId) {
        setStatus('error', 'è¯·è¾“å…¥æ–°çš„ ID');
        return;
      }
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'update-instance-id', 
          newId: newId 
        } 
      }, '*');
      setStatus('loading', 'æ­£åœ¨æ›´æ–° ID...');
    };
    
    // Enable update button when new ID is entered
    newIdInput.oninput = () => {
      btnUpdateInstanceId.disabled = !newIdInput.value.trim();
    };

    // ... existing code ...

    function extractArray(obj) {
      if (typeof obj !== 'object' || obj === null) return null;
      
      // 1. Try common keys
      const keys = ['data', 'results', 'items', 'records', 'rows', 'list', 'entries', 'json', 'body'];
      for (const k of keys) {
        const val = obj[k];
        if (Array.isArray(val)) return val;
        // Handle stringified JSON (common in some webhooks)
        if (typeof val === 'string') {
          try {
            const parsed = JSON.parse(val);
            if (Array.isArray(parsed)) return parsed;
          } catch {}
        }
      }
      
      // 2. Iterate all keys if strict common keys didn't work
      for (const k of Object.keys(obj)) {
        const val = obj[k];
        if (Array.isArray(val)) return val;
        if (typeof val === 'string') {
          try {
            const parsed = JSON.parse(val);
            if (Array.isArray(parsed)) return parsed;
          } catch {}
        }
      }
      
      return null;
    }

    function renderMappingUI(layers) {
      mappingList.innerHTML = '';
      
      // Populate ID Select
      idFieldSelect.innerHTML = '';
      schemaKeys.forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        if (key.toLowerCase() === 'id') opt.selected = true;
        idFieldSelect.appendChild(opt);
      });

      // Populate Layer Mappings
      layers.forEach(layer => {
        const div = document.createElement('div');
        div.className = 'mapping-item';
        div.dataset.layer = layer.name;
        div.dataset.type = layer.type;

        let icon = layer.type === 'TEXT' ? 'T' : 'ğŸ–¼ï¸';
        
        // Auto-match logic
        let selectedField = '__ignore__'; // Initialize to ignore

        // Try exact match or match without '#' prefix
        const cleanName = layer.name.replace(/^#/, '');
        if (schemaKeys.includes(layer.name)) {
           selectedField = layer.name;
        } else if (schemaKeys.includes(cleanName)) {
           selectedField = cleanName;
        }

        const optionsHtml = schemaKeys.map(k => 
          `<option value="${k}" ${k === selectedField ? 'selected' : ''}>${k}</option>`
        ).join('');

        div.innerHTML = `
          <div class="layer-info">
            <span class="layer-icon">${icon}</span>
            <span class="layer-name">${layer.name}</span>
            <span class="layer-type">${layer.type}</span>
          </div>
          <select data-dtype="${layer.type === 'TEXT' ? 'text' : 'image'}">
            <option value="__ignore__">-- å¿½ç•¥ --</option>
            ${optionsHtml}
          </select>
        `;
        mappingList.appendChild(div);
      });
    }

    // Step 4: Sync
    btnSync.onclick = () => {
      console.log('é»æ“ŠåŒæ­¥æŒ‰éˆ•');
      
      // æ¸…ç©ºå¹¶æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
      clearLog();
      addLog('ğŸš€ å¼€å§‹åŒæ­¥ä»»åŠ¡', 'info');
      
      setStatus('loading', 'æº–å‚™åŒæ­¥...');
      const mappings = [];
      
      const items = document.querySelectorAll('.mapping-item');
      console.log(`æ‰¾åˆ° ${items.length} å€‹æ˜ å°„é …ç›®`);
      addLog(`æ‰¾åˆ° ${items.length} ä¸ªæ˜ å°„é¡¹ç›®`, 'info');

      items.forEach(item => {
        const layerName = item.dataset.layer;
        const layerType = item.dataset.type;
        const select = item.querySelector('select');
        const dataField = select.value;
        
        if (dataField && dataField !== '__ignore__') {
          // æ”¹è¿›åˆ¤æ–­ï¼šTEXT æ˜¯æ–‡å­—ï¼Œå…¶ä»–éƒ½è§†ä¸ºå›¾ç‰‡ï¼ˆåŒ…æ‹¬ RECTANGLE, ELLIPSE, FRAMEç­‰ï¼‰
          const dataType = layerType === 'TEXT' ? 'text' : 'image';
          console.log(`[Mapping] ${layerName} (${layerType}) â†’ ${dataField} [${dataType}]`);
          mappings.push({ layerName, dataField, dataType });
        }
      });

      console.log('ç”Ÿæˆçš„æ˜ å°„è¦å‰‡:', mappings);
      addLog(`ç”Ÿæˆ ${mappings.length} æ¡æ˜ å°„è§„åˆ™`, 'success');

      if (mappings.length === 0) {
        console.warn('æ˜ å°„è¦å‰‡ç‚ºç©º');
        addLog('âŒ æ˜ å°„è§„åˆ™ä¸ºç©º', 'error');
        return setStatus('error', 'è«‹è‡³å°‘è¨­å®šä¸€å€‹æ˜ å°„æ¬„ä½');
      }

      const idField = idFieldSelect.value;
      console.log('ID Field:', idField);
      addLog(`ä½¿ç”¨ ID å­—æ®µ: ${idField}`, 'info');

      parent.postMessage({ 
        pluginMessage: { 
          type: 'sync-mapped-data',
          componentId: currentComponentId,
          data: notionData,
          mappings,
          idField
        } 
      }, '*');
      
      // ä¿å­˜ mappings ä¾›åç»­ä½¿ç”¨ï¼ˆä¾‹å¦‚ï¼šåŒæ­¥é€‰ä¸­åŠŸèƒ½ã€å›¾ç‰‡åŒæ­¥ï¼‰
      saveStorage('mapping_' + currentComponentId, JSON.stringify(mappings));
      currentMappings = mappings; // Store for later use
      
      console.log('å·²ç™¼é€ sync-mapped-data è¨Šæ¯');
      addLog(`ğŸ“¤ å‘é€åŒæ­¥æ•°æ® (${notionData.length} æ¡è®°å½•)`, 'info');
      setStatus('loading', 'æ­£åœ¨åŒæ­¥æ•¸æ“š... (è«‹ç¨å€™)');
    };

    // å¸¦é‡è¯•æœºåˆ¶çš„å›¾ç‰‡ä¸‹è½½
    async function fetchWithRetry(url, retries = 3) {
      let lastError;
      for (let i = 0; i < retries; i++) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          return response;
        } catch (e) {
          lastError = e;
          console.warn(`[å›¾ç‰‡ä¸‹è½½] ç¬¬ ${i + 1} æ¬¡å°è¯•å¤±è´¥:`, e.message);
          if (i < retries - 1) {
            // ç­‰å¾…åé‡è¯•ï¼Œå»¶è¿Ÿé€’å¢
            await new Promise(resolve => setTimeout(resolve, (i + 1) * 1000));
          }
        }
      }
      throw lastError;
    }

    /**
     * å‹ç¼©å›¾ç‰‡ä»¥ç¬¦åˆ Figma çš„å¤§å°é™åˆ¶
     * Figma é™åˆ¶: æœ€å¤§ 4096x4096 åƒç´ ï¼Œå»ºè®®æ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 4MB
     * Figma ä¸æ”¯æŒ WEBPï¼Œä¼šè‡ªåŠ¨è½¬æ¢ä¸º PNG
     */
    async function compressImage(arrayBuffer) {
      const MAX_DIMENSION = 4096;
      const MAX_FILE_SIZE = 4 * 1024 * 1024; // 4MB
      
      // æ£€æµ‹åŸå§‹å›¾ç‰‡æ ¼å¼
      const bytes = new Uint8Array(arrayBuffer);
      let originalFormat = 'jpeg'; // é»˜è®¤
      let outputFormat = 'image/jpeg'; // è¾“å‡ºæ ¼å¼
      
      // æ£€æµ‹å›¾ç‰‡æ ¼å¼é€šè¿‡æ–‡ä»¶å¤´ï¼ˆmagic bytesï¼‰
      if (bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47) {
        originalFormat = 'png';
        outputFormat = 'image/png';
      } else if (bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF) {
        originalFormat = 'jpeg';
        outputFormat = 'image/jpeg';
      } else if (bytes[0] === 0x52 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x46) {
        originalFormat = 'webp';
        outputFormat = 'image/png'; // WEBP è½¬æ¢ä¸º PNGï¼Œå› ä¸º Figma ä¸æ”¯æŒ WEBP
        console.log(`[å›¾ç‰‡å‹ç¼©] æ£€æµ‹åˆ° WEBP æ ¼å¼ï¼Œå°†è½¬æ¢ä¸º PNG`);
      }
      
      console.log(`[å›¾ç‰‡å‹ç¼©] åŸå§‹æ ¼å¼: ${originalFormat}, è¾“å‡ºæ ¼å¼: ${outputFormat}`);
      
      // WEBP å¿…é¡»è½¬æ¢ä¸º PNGï¼Œå³ä½¿æ–‡ä»¶å¾ˆå°
      const needsConversion = originalFormat === 'webp';
      const needsCompression = arrayBuffer.byteLength > MAX_FILE_SIZE;
      
      // å¦‚æœæ–‡ä»¶å·²ç»å¾ˆå°ä¸”ä¸éœ€è¦æ ¼å¼è½¬æ¢ï¼Œç›´æ¥è¿”å›
      if (!needsConversion && !needsCompression) {
        console.log(`[å›¾ç‰‡å‹ç¼©] åŸå§‹å¤§å°: ${(arrayBuffer.byteLength / 1024).toFixed(1)}KBï¼Œæ— éœ€å¤„ç†`);
        return new Uint8Array(arrayBuffer);
      }
      
      if (needsConversion && !needsCompression) {
        console.log(`[å›¾ç‰‡å‹ç¼©] éœ€è¦æ ¼å¼è½¬æ¢ä½†æ— éœ€å‹ç¼©`);
      } else if (needsCompression) {
        console.log(`[å›¾ç‰‡å‹ç¼©] åŸå§‹å¤§å°: ${(arrayBuffer.byteLength / 1024).toFixed(1)}KBï¼Œå¼€å§‹å¤„ç†...`);
      }
      
      return new Promise((resolve, reject) => {
        // ä½¿ç”¨åŸå§‹æ ¼å¼åˆ›å»º blob ä»¥ä¾¿æ­£ç¡®åŠ è½½å›¾ç‰‡
        const originalMimeType = originalFormat === 'png' ? 'image/png' : 
                                 originalFormat === 'jpeg' ? 'image/jpeg' : 
                                 'image/webp';
        const blob = new Blob([arrayBuffer], { type: originalMimeType });
        const img = new Image();
        const url = URL.createObjectURL(blob);
        
        img.onload = () => {
          URL.revokeObjectURL(url);
          
          let width = img.width;
          let height = img.height;
          
          // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
          let scale = 1;
          if (width > MAX_DIMENSION || height > MAX_DIMENSION) {
            scale = Math.min(MAX_DIMENSION / width, MAX_DIMENSION / height);
            width = Math.floor(width * scale);
            height = Math.floor(height * scale);
            console.log(`[å›¾ç‰‡å‹ç¼©] åŸå§‹å°ºå¯¸: ${img.width}x${img.height}, ç¼©æ”¾è‡³: ${width}x${height}`);
          }
          
          // åˆ›å»º Canvas è¿›è¡Œå¤„ç†
          const canvas = document.createElement('canvas');
          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, width, height);
          
          // PNG ä½¿ç”¨è´¨é‡ 1.0ï¼ˆæ— æŸï¼‰ï¼ŒJPEG ä½¿ç”¨é€’å‡è´¨é‡
          let quality = outputFormat === 'image/png' ? 1.0 : 0.9;
          
          const tryCompress = () => {
            canvas.toBlob(async (blob) => {
              if (!blob) {
                reject(new Error('å¤„ç†å¤±è´¥'));
                return;
              }
              
              // å¦‚æœæ˜¯ JPEG ä¸”æ–‡ä»¶ä»ç„¶å¤ªå¤§ï¼Œé™ä½è´¨é‡
              if (outputFormat === 'image/jpeg' && blob.size > MAX_FILE_SIZE && quality > 0.3) {
                quality -= 0.1;
                console.log(`[å›¾ç‰‡å‹ç¼©] å½“å‰å¤§å°: ${(blob.size / 1024).toFixed(1)}KBï¼Œé™ä½è´¨é‡è‡³ ${(quality * 100).toFixed(0)}%`);
                tryCompress();
                return;
              }
              
              const finalBuffer = await blob.arrayBuffer();
              console.log(`[å›¾ç‰‡å‹ç¼©] å¤„ç†å®Œæˆ: ${(finalBuffer.byteLength / 1024).toFixed(1)}KB (æ ¼å¼: ${outputFormat}${outputFormat === 'image/jpeg' ? `, è´¨é‡: ${(quality * 100).toFixed(0)}%` : ''})`);
              resolve(new Uint8Array(finalBuffer));
            }, outputFormat, quality);
          };
          
          tryCompress();
        };
        
        img.onerror = () => {
          URL.revokeObjectURL(url);
          reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        };
        
        img.src = url;
      });
    }

    async function downloadAndSendImages(mappings, selectedNotionIds = null, forceUpdate = false) {
      console.log('[å›¾ç‰‡åŒæ­¥] å¼€å§‹å¤„ç†å›¾ç‰‡ï¼Œmappings:', mappings);
      console.log('[å›¾ç‰‡åŒæ­¥] é€‰ä¸­çš„Notion IDs:', selectedNotionIds);
      console.log('[å›¾ç‰‡åŒæ­¥] å¼ºåˆ¶æ›´æ–°æ¨¡å¼:', forceUpdate);
      addLog('ğŸ–¼ï¸ å¼€å§‹å›¾ç‰‡åŒæ­¥', 'info');
      
      // 1. Get List of Notion IDs to process
      let notionIds;
      if (selectedNotionIds && selectedNotionIds.length > 0) {
        // åªå¤„ç†é€‰ä¸­çš„instance
        notionIds = selectedNotionIds;
        addLog(`åªå¤„ç†é€‰ä¸­çš„ ${notionIds.length} ä¸ª instance çš„å›¾ç‰‡`, 'info');
        if (forceUpdate) {
          addLog('âš¡ å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼šè·³è¿‡URLæ¯”è¾ƒï¼Œç›´æ¥ä¸‹è½½æ‰€æœ‰å›¾ç‰‡', 'info');
        }
      } else {
        // å¤„ç†æ‰€æœ‰æ•°æ®
        notionIds = notionData.map((item, i) => String(item[idFieldSelect.value] || `row-${i}`));
      }
      console.log('[å›¾ç‰‡åŒæ­¥] å¤„ç†çš„ Notion IDs:', notionIds);
      
      setStatus('loading', 'æ­£åœ¨æª¢æŸ¥ç¾æœ‰åœ–ç‰‡...');
      addLog('æ­£åœ¨æ£€æŸ¥ç°æœ‰å›¾ç‰‡...', 'info');
      
      // 2. Ask Backend for existing URLs
      // Wrap in Promise to wait for response
      const existingUrls = await new Promise((resolve) => {
        const handler = (e) => {
          const msg = e.data.pluginMessage;
          if (msg && msg.type === 'image-urls') {
            window.removeEventListener('message', handler);
            resolve(msg.urls || {});
          }
        };
        window.addEventListener('message', handler);
        parent.postMessage({ pluginMessage: { type: 'get-image-urls', notionIds } }, '*');
        
        // Timeout fallback
        setTimeout(() => {
           window.removeEventListener('message', handler);
           resolve({});
        }, 2000);
      });

      // Filter data to process based on notionIds
      const itemsToProcess = notionData.filter((item, i) => {
        const id = String(item[idFieldSelect.value] || `row-${i}`);
        return notionIds.includes(id);
      });

      setStatus('loading', 'æ­£åœ¨ä¸‹è¼‰åœ–ç‰‡...');
      addLog(`å¼€å§‹ä¸‹è½½å›¾ç‰‡ (æ€»è®¡ ${itemsToProcess.length} æ¡è®°å½•)`, 'info');
      
      let downloaded = 0;     // å®é™…ä¸‹è½½çš„å›¾ç‰‡æ•°
      let skippedSame = 0;    // è·³è¿‡ï¼ˆURLç›¸åŒï¼‰
      let skippedNoUrl = 0;   // è·³è¿‡ï¼ˆæ— URLæˆ–æ— æ•ˆURLï¼‰
      let failed = 0;         // ä¸‹è½½å¤±è´¥

      for (let i = 0; i < itemsToProcess.length; i++) {
        const item = itemsToProcess[i];
        const idValue = String(item[idFieldSelect.value] || `row-${i}`); // Need consistent ID generation
        const currentImages = existingUrls[idValue] || {};
        console.log(`[å›¾ç‰‡åŒæ­¥] å¤„ç†è®°å½• ${i+1}/${itemsToProcess.length}, ID: ${idValue}`);
        
        // æ¯å¤„ç† 5 æ¡è®°å½•æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        if ((i + 1) % 5 === 0 || i === 0) {
          addLog(`å¤„ç†è®°å½• ${i+1}/${itemsToProcess.length}`, 'info');
        }

        for (const m of mappings) {
          const newUrl = item[m.dataField];
          console.log(`[å›¾ç‰‡åŒæ­¥]   å›¾å±‚: ${m.layerName}, æ–°URL: ${newUrl}`);
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å›¾ç‰‡ URL
          if (typeof newUrl === 'string' && newUrl.startsWith('http')) {
             // 3. Compare with existing URL (Ignore Query Params)
             // å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼šè·³è¿‡URLæ¯”è¾ƒï¼Œç›´æ¥ä¸‹è½½
             if (forceUpdate) {
               console.log(`[å›¾ç‰‡åŒæ­¥]   â†’ å¼ºåˆ¶æ›´æ–°æ¨¡å¼ï¼Œç›´æ¥ä¸‹è½½`);
             } else {
               // Notion URLs change query params (signatures) but base path is stable.
               const oldUrl = currentImages[m.layerName]; // Get existing URL for this layer
               const cleanOld = oldUrl ? oldUrl.split('?')[0] : '';
               const cleanNew = newUrl.split('?')[0];

               // DEBUG LOG - æ˜¾ç¤ºå®Œæ•´çš„æ¸…ç†åURLä»¥ä¾¿è°ƒè¯•
               if (oldUrl) {
                  console.log(`[ImgDebug] ID:${idValue} Layer:${m.layerName}`);
                  console.log(`   Old(Clean): ${cleanOld}`);
                  console.log(`   New(Clean): ${cleanNew}`);
                  console.log(`   Match: ${cleanOld === cleanNew}`);
               }

               if (cleanOld === cleanNew) {
                 console.log(`[å›¾ç‰‡åŒæ­¥]   â†’ è·³è¿‡ï¼ˆURLç›¸åŒï¼‰`);
                 skippedSame++;
                 continue; // SKIP DOWNLOAD
               }
             }
          
            try {
              console.log(`[å›¾ç‰‡åŒæ­¥]   â†’ å¼€å§‹ä¸‹è½½: ${newUrl}`);
              const resp = await fetchWithRetry(newUrl, 3); // ä½¿ç”¨é‡è¯•æœºåˆ¶ï¼Œæœ€å¤š3æ¬¡
              const buffer = await resp.arrayBuffer();
              
              // å‹ç¼©å›¾ç‰‡ä»¥ç¬¦åˆ Figma é™åˆ¶
              const compressedBytes = await compressImage(buffer);
              
              parent.postMessage({
                pluginMessage: {
                  type: 'set-image',
                  notionId: idValue,
                  layerName: m.layerName,
                  imageBytes: compressedBytes,
                  imageUrl: newUrl // Send URL to save
                }
              }, '*');
              console.log(`[å›¾ç‰‡åŒæ­¥]   â†’ å·²ä¸‹è½½å¹¶å‹ç¼©`);
              downloaded++;
              
              // æ¯ä¸‹è½½ 3 å¼ å›¾ç‰‡æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
              if (downloaded % 3 === 0) {
                addLog(`âœ… å·²ä¸‹è½½ ${downloaded} å¼ å›¾ç‰‡`, 'success');
              }
            } catch (e) {
              const errorMsg = e instanceof Error ? e.message : String(e);
              console.error(`[å›¾ç‰‡åŒæ­¥]   â†’ ä¸‹è½½å¤±è´¥: ${errorMsg}`);
              console.error(`[å›¾ç‰‡åŒæ­¥]   â†’ å¤±è´¥çš„ URL: ${newUrl}`);
              addLog(`âŒ ä¸‹è½½å¤±è´¥: ${m.layerName}`, 'error');
              failed++;
            }
          } else {
            // æ— URLæˆ–æ— æ•ˆURL
            console.log(`[å›¾ç‰‡åŒæ­¥]   â†’ è·³è¿‡ï¼ˆæ— æœ‰æ•ˆURLï¼‰`);
            skippedNoUrl++;
          }
          
          const processed = downloaded + skippedSame + skippedNoUrl + failed;
          if (processed % 5 === 0) {
            setStatus('loading', `è™•ç†åœ–ç‰‡ ${processed}/${notionData.length * mappings.length} (å·²ä¸‹è¼‰ ${downloaded}, è·³é ${skippedSame + skippedNoUrl})...`);
          }
        }
      }
      
      const total = downloaded + skippedSame + skippedNoUrl + failed;
      const successMsg = `åŒæ­¥å®Œæˆï¼å·²ä¸‹è¼‰ ${downloaded} å¼µæ–°åœ–ç‰‡ï¼Œè·³é ${skippedSame} å¼µç›¸åŒåœ–ç‰‡ï¼Œ${skippedNoUrl} å€‹ç„¡åœ–ç‰‡æ¬„ä½` + (failed > 0 ? `ï¼Œ${failed} å¼µä¸‹è¼‰å¤±æ•—` : '');
      setStatus('success', successMsg);
      addLog(successMsg, 'success');
      addLog(`ğŸ“Š ç»Ÿè®¡: ä¸‹è½½ ${downloaded}, è·³è¿‡ ${skippedSame + skippedNoUrl}, å¤±è´¥ ${failed}`, 'info');
      btnSync.disabled = false;
    }

    // --- Helpers ---
    
    function renderPreview(index = 0) {
      if (!notionData || notionData.length === 0) return;
      
      // Boundary checks
      if (index < 0) index = 0;
      if (index >= notionData.length) index = notionData.length - 1;
      
      currentPreviewIndex = index;
      const record = notionData[index];
      
      // Update Counter
      const counterEl = document.getElementById('preview-counter');
      if (counterEl) {
        counterEl.textContent = `${index + 1} / ${notionData.length}`;
      }
      
      // Update Buttons
      const btnPrev = document.getElementById('btn-prev-record');
      const btnNext = document.getElementById('btn-next-record');
      
      if (btnPrev) btnPrev.disabled = (index === 0);
      if (btnNext) btnNext.disabled = (index === notionData.length - 1);
      
      previewList.innerHTML = '';
      schemaKeys.forEach(key => {
        const div = document.createElement('div');
        div.className = 'preview-item'; // Changed from mapping-item
        div.style.display = 'flex';
        div.style.justifyContent = 'space-between';
        
        const keySpan = document.createElement('span');
        keySpan.style.fontWeight = 'bold';
        keySpan.style.color = '#ddd';
        keySpan.textContent = key;
        
        const valSpan = document.createElement('span');
        valSpan.style.color = '#aaa';
        valSpan.style.fontSize = '10px';
        valSpan.style.maxWidth = '150px';
        valSpan.style.overflow = 'hidden';
        valSpan.style.textOverflow = 'ellipsis';
        valSpan.style.whiteSpace = 'nowrap';
        let val = record[key];
        if (typeof val === 'object') val = JSON.stringify(val);
        valSpan.textContent = String(val);

        div.appendChild(keySpan);
        div.appendChild(valSpan);
        previewList.appendChild(div);
      });
    }

    // Navigation Event Listeners
    const btnPrevRecord = document.getElementById('btn-prev-record');
    const btnNextRecord = document.getElementById('btn-next-record');

    if (btnPrevRecord) {
      btnPrevRecord.onclick = () => {
        if (currentPreviewIndex > 0) {
          renderPreview(currentPreviewIndex - 1);
        }
      };
    }

    if (btnNextRecord) {
      btnNextRecord.onclick = () => {
        if (currentPreviewIndex < notionData.length - 1) {
          renderPreview(currentPreviewIndex + 1);
        }
      };
    }


    // --- Message Handler ---
    window.onmessage = (event) => {
      try {
        const msg = event.data.pluginMessage;
        console.log('Frontend received message:', msg);
        if (!msg) return;

        if (msg.type === 'version-info') {
           const vDisplay = document.getElementById('version-display');
           if(vDisplay) vDisplay.textContent = 'v' + msg.version;
        }

        else if (msg.type === 'component-data') {
          // å¦‚æœæ˜¯å¿«é€ŸåŠ è½½ (fromSelection)ï¼Œç”±å±€éƒ¨å¤„ç†å‡½æ•°å¤„ç†ï¼Œå¿½ç•¥æ­¤å¤„ä»¥é˜²è·³è½¬ UI
          if (msg.fromSelection) return;

          currentComponentId = msg.componentId;
          componentLayers = msg.layers;
          
          // ä¿å­˜é€‰ä¸­çš„ Component IDï¼Œä¸‹æ¬¡è‡ªåŠ¨æ¢å¤
          saveStorage('last_component_id', currentComponentId);
          console.log('[å­˜å‚¨] å·²ä¿å­˜ Component ID:', currentComponentId);
          
          // Try to load saved mappings for this component
          setStatus('loading', 'æ­£åœ¨è®€å–å„²å­˜çš„æ˜ å°„è¨­å®š...');
          loadStorage('mapping_' + currentComponentId);
          
          try {
            renderMappingUI(componentLayers);
          } catch (e) {
            console.error('Render UI Error:', e);
            setStatus('error', 'æ¸²æŸ“ä»‹é¢å¤±æ•—: ' + e.message);
          }
          
          document.getElementById('comp-name').textContent = msg.componentName;
          document.getElementById('selected-comp-info').classList.remove('hidden');
          
          if (componentLayers.length === 0) {
            setStatus('error', 'æœªæ‰¾åˆ°åç¨±å« # çš„åœ–å±¤ (è«‹æª¢æŸ¥åœ–å±¤åç¨±)');
            btnSync.disabled = true;
          } else {
            setStatus('success', 'å·²è®€å– Componentï¼Œè«‹è¨­å®šæ˜ å°„');
            console.log('Enabling Sync button manually from code');
            btnSync.removeAttribute('disabled'); // Ensure attribute is gone
            btnSync.disabled = false;
            
            // Try to load saved mappings for this component
            setStatus('loading', 'æ­£åœ¨è®€å–å„²å­˜çš„æ˜ å°„è¨­å®š...');
            loadStorage('mapping_' + currentComponentId);
          }
          showStep(3);
        }
        else if (msg.type === 'component-layers') {
          // å¤„ç†ã€Œè¯»å–é€‰ä¸­çš„ Componentã€è¿”å›çš„æ•°æ®
          console.log('Processing component-layers...');
          componentLayers = msg.layers;
          currentComponentId = msg.componentId;
          
          // ä¿å­˜é€‰ä¸­çš„ Component ID
          saveStorage('last_component_id', currentComponentId);
          console.log('[å­˜å‚¨] å·²ä¿å­˜ Component ID:', currentComponentId);
          
          try {
            renderMappingUI(componentLayers);
          } catch (e) {
            console.error('Render UI Error:', e);
            setStatus('error', 'æ¸²æŸ“ä»‹é¢å¤±æ•—: ' + e.message);
          }
          
          document.getElementById('comp-name').textContent = msg.componentName;
          document.getElementById('selected-comp-info').classList.remove('hidden');
          
          if (componentLayers.length === 0) {
            setStatus('error', 'æœªæ‰¾åˆ°åç¨±å« # çš„åœ–å±¤ (è«‹æª¢æŸ¥åœ–å±¤åç¨±)');
            btnSync.disabled = true;
          } else {
            setStatus('success', 'å·²è®€å– Componentï¼Œè«‹è¨­å®šæ˜ å°„');
            btnSync.disabled = false;
            
            // Try to load saved mappings for this component
            setStatus('loading', 'æ­£åœ¨è®€å–å„²å­˜çš„æ˜ å°„è¨­å®š...');
            loadStorage('mapping_' + currentComponentId);
          }
          showStep(3);
        }
        else if (msg.type === 'status') {
          setStatus('loading', msg.message);
        }
        else if (msg.type === 'error') {
          setStatus('error', msg.message);
          btnSync.disabled = false;
        }
        else if (msg.type === 'done') {
          // Check if we need to sync images
          const imageMappings = currentMappings.filter(m => m.dataType !== 'text');
          
          if (imageMappings.length > 0) {
            setStatus('success', msg.message + ' (é–‹å§‹è™•ç†åœ–ç‰‡...)');
            addLog(`âœ… ${msg.message}`, 'success');
            addLog(`æ£€æµ‹åˆ° ${imageMappings.length} ä¸ªå›¾ç‰‡æ˜ å°„ï¼Œå¼€å§‹å›¾ç‰‡åŒæ­¥`, 'info');
            downloadAndSendImages(imageMappings);
          } else {
            setStatus('success', msg.message);
            addLog(`âœ… ${msg.message}`, 'success');
            addLog('æœªæ£€æµ‹åˆ°å›¾ç‰‡æ˜ å°„ï¼ŒåŒæ­¥å®Œæˆ', 'info');
            btnSync.disabled = false;
          }
          showSyncAgain(); // Show "Sync Again" button
        }
        else if (msg.type === 'instance-id-info') {
          // Display current instance ID
          currentIdValue.textContent = msg.currentId;
          currentNodeName.textContent = `èŠ‚ç‚¹: ${msg.nodeName}`;
          currentIdDisplay.classList.remove('hidden');
          newIdInput.value = ''; // Clear input
          btnUpdateInstanceId.disabled = true;
          setStatus('success', 'å·²è¯»å– Instance ID');
        }
        else if (msg.type === 'id-updated') {
          // ID updated successfully
          setStatus('success', msg.message);
          // Clear form
          currentIdDisplay.classList.add('hidden');
          newIdInput.value = '';
          btnUpdateInstanceId.disabled = true;
        }
        else if (msg.type === 'sync-selected-done') {
          // åŒæ­¥é€‰ä¸­å®Œæˆ
          console.log('[sync-selected-done] æ”¶åˆ°æ¶ˆæ¯:', msg);
          console.log('[sync-selected-done] updatedNotionIds:', msg.updatedNotionIds);
          addLog(`âœ… ${msg.message}`, 'success');
          
          // æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥å›¾ç‰‡
          const imageMappings = currentMappings.filter(m => m.dataType !== 'text');
          console.log('[sync-selected-done] imageMappings æ•°é‡:', imageMappings.length);
          
          if (imageMappings.length > 0 && msg.updatedNotionIds && msg.updatedNotionIds.length > 0) {
            setStatus('success', msg.message + ' (é–‹å§‹è™•ç†åœ–ç‰‡...)');
            addLog(`æ£€æµ‹åˆ° ${imageMappings.length} ä¸ªå›¾ç‰‡æ˜ å°„ï¼Œå¼€å§‹å›¾ç‰‡åŒæ­¥`, 'info');
            console.log('[sync-selected-done] è°ƒç”¨ downloadAndSendImagesï¼ŒIDs:', msg.updatedNotionIds);
            // åªå¤„ç†æ›´æ–°çš„instanceçš„å›¾ç‰‡ï¼Œä½¿ç”¨å¼ºåˆ¶æ›´æ–°æ¨¡å¼
            downloadAndSendImages(imageMappings, msg.updatedNotionIds, true);
          } else {
            setStatus('success', msg.message);
            addLog('æœªæ£€æµ‹åˆ°å›¾ç‰‡æ˜ å°„æˆ–æ— æ›´æ–°çš„instanceï¼ŒåŒæ­¥å®Œæˆ', 'info');
            if (btnSyncSelected) btnSyncSelected.disabled = false;
          }
        }
        else if (msg.type === 'storage-data') {
          if (msg.key === 'webhook_url' && msg.value) {
            webhookInput.value = msg.value;
            // Auto-fetch if URL exists
            if (msg.value && msg.value.startsWith('http')) {
              console.log('[è‡ªåŠ¨è·å–] URL å·²å­˜åœ¨ï¼Œè‡ªåŠ¨æ‹‰å–æ•°æ®...');
              btnFetch.click();
            }
          }
          if (msg.key === 'last_component_id' && msg.value) {
            console.log('[è‡ªåŠ¨æ¢å¤] ä¸Šæ¬¡é€‰æ‹©çš„ Component ID:', msg.value);
            // å‘é€æ¶ˆæ¯åˆ°åç«¯ï¼Œè¯·æ±‚éªŒè¯å¹¶åŠ è½½è¿™ä¸ª Component
            parent.postMessage({ 
              pluginMessage: { 
                type: 'restore-component',
                componentId: msg.value
              } 
            }, '*');
          }
          
          if (msg.key === 'cached_data' && msg.value) {
            try {
              const parsed = JSON.parse(msg.value);
              if (Array.isArray(parsed) && parsed.length > 0) {
                 notionData = parsed;
                 const allKeys = new Set();
                 parsed.slice(0, 5).forEach(item => Object.keys(item).forEach(k => allKeys.add(k)));
                 schemaKeys = Array.from(allKeys);
                 renderPreview(0);
                 showStep('preview');
                 setStatus('success', `å·²è¼‰å…¥ç·©å­˜æ•¸æ“š (${parsed.length} ç­†)`);
              }
            } catch (e) {
              console.warn('Failed to parse cached data from storage', e);
            }
          }

          if (msg.key === `mapping_${currentComponentId}` && msg.value) {
            console.log('Loaded saved mappings:', msg.value);
            renderMappingUI(componentLayers, msg.value);
            setStatus('success', 'å·²è‡ªå‹•å¥—ç”¨ä¸Šæ¬¡çš„æ˜ å°„è¨­å®š');
          }
        }
      } catch (err) {
        console.error('Window onmessage error:', err);
        setStatus('error', 'Plugin éŒ¯èª¤: ' + err.message);
      }
    };

    // Refactored renderMappingUI for safety
    function renderMappingUI(layers, savedMappings = null) {
      mappingList.innerHTML = '';
      
      // Populate ID Select
      idFieldSelect.innerHTML = '';
      schemaKeys.forEach(key => {
        const opt = document.createElement('option');
        opt.value = key;
        opt.textContent = key;
        if (key.toLowerCase() === 'id') opt.selected = true;
        // Restore ID selection if saved
        if (savedMappings && savedMappings.idField && key === savedMappings.idField) {
           opt.selected = true;
        }
        idFieldSelect.appendChild(opt);
      });

      // Populate Layer Mappings
      layers.forEach(layer => {
        const div = document.createElement('div');
        div.className = 'mapping-item';
        div.dataset.layer = layer.name;
        div.dataset.type = layer.type;

        let icon = layer.type === 'TEXT' ? 'T' : 'ğŸ–¼ï¸';
        
        const layerInfoComp = document.createElement('div');
        layerInfoComp.className = 'layer-info';
        layerInfoComp.innerHTML = `
            <span class="layer-icon">${icon}</span>
            <span class="layer-name" title="${layer.name}">${layer.name}</span>
            <span class="layer-type">${layer.type}</span>
        `;

        const select = document.createElement('select');
        select.dataset.dtype = layer.type === 'TEXT' ? 'text' : 'image';
        
        // Default Ignore Option
        const defaultOpt = document.createElement('option');
        defaultOpt.value = '__ignore__';
        defaultOpt.textContent = '-- å¿½ç•¥ --';
        select.appendChild(defaultOpt);

        // Auto-match logic
        let selectedField = '__ignore__'; 
        
        // 1. Try saved mapping first
        if (savedMappings && Array.isArray(savedMappings.mappings)) {
           const found = savedMappings.mappings.find(m => m.layerName === layer.name);
           if (found) selectedField = found.dataField;
        } 
        
        // 2. If no saved mapping, try auto-match
        if (selectedField === '__ignore__') {
            const cleanName = layer.name.replace(/^#/, '');
            if (schemaKeys.includes(layer.name)) {
               selectedField = layer.name;
            } else if (schemaKeys.includes(cleanName)) {
               selectedField = cleanName;
            }
        }

        // Add Schema Options
        schemaKeys.forEach(k => {
          const opt = document.createElement('option');
          opt.value = k;
          opt.textContent = k;
          if (k === selectedField) opt.selected = true;
          select.appendChild(opt);
        });

        div.appendChild(layerInfoComp);
        div.appendChild(select);
        mappingList.appendChild(div);
      });
    }

    // Step 4: Sync
    btnSync.onclick = () => {
      try {
        console.log('é»æ“ŠåŒæ­¥æŒ‰éˆ• (Click triggered)');
        setStatus('loading', 'æ­£åœ¨é–‹å§‹åŒæ­¥...'); // Immediate feedback
        
        const mappings = [];
        // Only select from the mapping list to avoid preview items
        const items = mappingList.querySelectorAll('.mapping-item');
        console.log(`æ‰¾åˆ° ${items.length} å€‹æ˜ å°„é …ç›®`);

        items.forEach(item => {
          const layerName = item.dataset.layer;
          const layerType = item.dataset.type;
          const select = item.querySelector('select');
          
          if (!select) {
            console.warn('Skipping item without select:', item);
            return;
          }
          
          const dataField = select.value;
          
          if (dataField && dataField !== '__ignore__') {
            mappings.push({ layerName, dataField, dataType: layerType !== 'TEXT' ? 'image' : 'text' });
          }
        });

        console.log('ç”Ÿæˆçš„æ˜ å°„è¦å‰‡:', mappings);
        currentMappings = mappings; // Save mappings for image phase

        if (mappings.length === 0) {
          console.warn('æ˜ å°„è¦å‰‡ç‚ºç©º');
          return setStatus('error', 'è«‹è‡³å°‘è¨­å®šä¸€å€‹æ˜ å°„æ¬„ä½');
        }

        const idField = idFieldSelect.value;
        console.log('ID Field:', idField);

        // Save Mappings for future use
        saveStorage('mapping_' + currentComponentId, { 
           mappings: mappings, 
           idField: idField 
        });

        // Hide Sync Again button if visible from previous run
        const btnAgain = document.getElementById('btn-sync-again');
        if (btnAgain) btnAgain.classList.add('hidden');

        parent.postMessage({ 
          pluginMessage: { 
            type: 'sync-mapped-data',
            componentId: currentComponentId,
            data: notionData,
            mappings,
            idField
          } 
        }, '*');
        
        console.log('å·²ç™¼é€ sync-mapped-data è¨Šæ¯');
        setStatus('loading', 'æ­£åœ¨åŒæ­¥æ•¸æ“š... (è«‹ç¨å€™)');
      } catch (e) {
        console.error('Sync Button Error:', e);
        setStatus('error', 'åŒæ­¥æŒ‰éˆ•éŒ¯èª¤: ' + e.message);
      }
    };
    
    // Create Sync Again Button dynamically
    const btnSyncAgain = document.createElement('button');
    btnSyncAgain.id = 'btn-sync-again';
    btnSyncAgain.className = 'w-full hidden'; // Initially hidden
    btnSyncAgain.style.marginTop = '8px';
    btnSyncAgain.style.background = '#4CAF50';
    btnSyncAgain.textContent = 'ğŸ”„ å†æ¬¡åŒæ­¥ (Fetch & Sync)';
    btnSyncAgain.onclick = async () => {
       setStatus('loading', 'æ­£åœ¨é‡æ–°æ‹‰å–æ•¸æ“š...');
       const success = await fetchData();
       if (success) {
          // Data refreshed, notionData updated.
          // Trigger Sync immediately
          setTimeout(() => btnSync.click(), 500);
       }
    };
    // Append to Step 3 container
    document.getElementById('step-3').appendChild(btnSyncAgain);

    function showSyncAgain() {
       btnSyncAgain.classList.remove('hidden');
    }

    // --- Storage Helpers (Phase 2 & 3) ---
    function saveStorage(key, value) {
      // Save to Figma ClientStorage (Async, Persistent)
      // Removed localStorage to avoid SecurityError in some environments
      parent.postMessage({ pluginMessage: { type: 'storage-set', key, value } }, '*');
    }

    function loadStorage(key) {
      return new Promise((resolve) => {
        const handler = (e) => {
          const msg = e.data.pluginMessage;
          if (msg && msg.type === 'storage-data' && msg.key === key) {
            window.removeEventListener('message', handler);
            resolve(msg.value);
          }
        };
        window.addEventListener('message', handler);
        parent.postMessage({ pluginMessage: { type: 'storage-get', key } }, '*');
        
        // Timeout
        setTimeout(() => {
          window.removeEventListener('message', handler);
          resolve(null);
        }, 2000);
      });
    }

    // --- Init ---
    try {
      // On load â†’ get saved webhook URL and last component
      loadStorage('webhook_url');
      loadStorage('last_component_id');
      loadStorage('cached_data');

    } catch (e) {
      console.warn('Init Error', e);
    }

    webhookInput.onchange = () => {
      saveStorage('webhook_url', webhookInput.value);
    };
  </script>
</body>
</html>
